{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterowanie roletami</title>
  <link rel="stylesheet" href="{% static 'shutters/style.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
  <h1>Sterowanie roletami</h1>

  {% for shutter in shutters %}
    <div class="shutter" data-id="{{ shutter.id }}">
      <h2>{{ shutter.name }}</h2>
      <p>Status:
        <span id="status-{{ shutter.id }}" class="status {{ shutter.current_state }}">
          <i class="fas fa-circle"></i>
          {% if shutter.current_state == 'open' %}open
          {% elif shutter.current_state == 'closed' %}closed
          {% elif shutter.current_state == 'inprogress' %}W trakcie
          {% else %}unknown
          {% endif %}
        </span>
      </p>

      <div class="duration-inputs">
        <label for="open-{{ shutter.id }}">Czas otwierania (s):</label>
        <input type="number" min="0" step="0.1" id="open-{{ shutter.id }}" value="{{ shutter.open_duration }}" />

        <label for="close-{{ shutter.id }}">Czas zamykania (s):</label>
        <input type="number" min="0" step="0.1" id="close-{{ shutter.id }}" value="{{ shutter.close_duration }}" />

        <button onclick="updateTimes({{ shutter.id }})">
          <i class="fas fa-save"></i> Zapisz czasy
        </button>
        <div id="saved-msg-{{ shutter.id }}" class="saved-msg" style="display:none;">Zapisano!</div>
      </div>

      <div class="button-group">
        <button id="btn-open-{{ shutter.id }}" onclick="control({{ shutter.id }}, 'open', {{ shutter.open_duration }})">
          <i class="fas fa-arrow-up"></i> Otw√≥rz
        </button>
        <button id="btn-close-{{ shutter.id }}" onclick="control({{ shutter.id }}, 'close', {{ shutter.close_duration }})">
          <i class="fas fa-arrow-down"></i> Zamknij
        </button>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="progress-{{ shutter.id }}"></div>
      </div>
    </div>
  {% endfor %}

  <br />
  <a href="/mqtt/settings/">Ustawienia MQTT</a>

  <script>
    function updateButtonStates(id, state) {
      const btnO = document.getElementById(`btn-open-${id}`);
      const btnC = document.getElementById(`btn-close-${id}`);

      if (state === 'inprogress') {
        // oba zablokowane
        btnO.disabled = btnC.disabled = true;
        btnO.style.background = btnC.style.background = '#6c757d';
      } else if (state === 'open') {
        btnO.disabled = true;
        btnO.style.background = '#6c757d';
        btnC.disabled = false;
        btnC.style.background = '#007bff';
      } else if (state === 'closed') {
        btnC.disabled = true;
        btnC.style.background = '#6c757d';
        btnO.disabled = false;
        btnO.style.background = '#007bff';
      } else {
        // unknown
        btnO.disabled = btnC.disabled = false;
        btnO.style.background = btnC.style.background = '#007bff';
      }
    }

    function renderStatus(id, state) {
      const span = document.getElementById(`status-${id}`);
      let label, color;
      if (state === 'open')      { label='open'; color='green'; }
      else if (state === 'closed'){ label='closed'; color='red'; }
      else if (state === 'inprogress'){ label='W trakcie'; color='orange'; }
      else                        { label='unknown'; color='gray'; }
      span.className = `status ${state}`;
      span.innerHTML = `<i class="fas fa-circle" style="color:${color}"></i> ${label}`;
    }

    function control(id, action, duration) {
      const btnO = document.getElementById(`btn-open-${id}`);
      const btnC = document.getElementById(`btn-close-${id}`);
      if ((action==='open' && btnO.disabled) || (action==='close' && btnC.disabled)) {
        alert(`Akcja '${action}' zablokowana.`);
        return;
      }
      fetch(`/shutter/${id}/${action}/`).then(() => {
        renderStatus(id, 'inprogress');
        updateButtonStates(id, 'inprogress');
        const bar = document.getElementById(`progress-${id}`);
        bar.style.transition='none'; bar.style.width='0%';
        setTimeout(()=>{ bar.style.transition=`width ${duration}s linear`; bar.style.width='100%'; },100);
        setTimeout(()=>{
          const finalState = action==='open' ? 'open' : 'closed';
          renderStatus(id, finalState);
          updateButtonStates(id, finalState);
        }, duration*1000);
      });
    }

    function updateTimes(id) {
      const open = parseFloat(document.getElementById(`open-${id}`).value);
      const close = parseFloat(document.getElementById(`close-${id}`).value);
      fetch(`/shutter/${id}/update_times/`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}' },
        body: JSON.stringify({ open_duration:open, close_duration:close })
      }).then(()=>{
        const msg=document.getElementById(`saved-msg-${id}`);
        msg.style.display='inline'; setTimeout(()=>msg.style.display='none',2000);
      });
    }

    window.onload = () => {
      {% for shutter in shutters %}
        renderStatus({{ shutter.id }}, '{{ shutter.current_state }}');
        updateButtonStates({{ shutter.id }}, '{{ shutter.current_state }}');
      {% endfor %}
    };

    setInterval(() => {
      fetch('/shutter/status/')
        .then(res=>res.json())
        .then(updates=>{
          updates.forEach(u=>{
            renderStatus(u.id, u.action);
            updateButtonStates(u.id, u.action);
            const bar=document.getElementById(`progress-${u.id}`);
            bar.style.transition='none'; bar.style.width='0%';
            setTimeout(()=>{ bar.style.transition=`width ${u.duration}s linear`; bar.style.width='100%'; },100);
            setTimeout(()=>{
              const fs = u.action==='open'?'open':'closed';
              renderStatus(u.id, fs);
              updateButtonStates(u.id, fs);
            }, u.duration*1000);
          });
        });
    },2000);
  </script>
</body>
</html>
